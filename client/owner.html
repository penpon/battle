<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terminal Takedown - Owner Lobby</title>
  <style>
    :root { --bg:#0b1020; --panel:#0f152b; --card:#121a34; --text:#e8ecf7; --muted:#a9b3cf; --ok:#15c57e; --ng:#ff5d5d; --accent:#5b8cff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif; color: var(--text); background: var(--bg); }
    header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.06); background: rgba(10,16,32,0.6); position: sticky; top:0; backdrop-filter: blur(6px); }
    h1 { margin: 0; font-size: 18px; letter-spacing: .5px; color: #fff; }
    main { padding: 16px 20px; max-width: 900px; margin: 0 auto; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 12px; }
    .row { display:flex; gap:10px; align-items:center; margin:10px 0; }
    label { min-width: 110px; color: var(--muted); font-size: 12px; }
    input[type=text], select { flex:1; background: #0c1430; color: var(--text); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 12px; outline: none; }
    button { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-weight: 600; }
    button.secondary { background: #1f2a4d; }
    .status { margin-top: 12px; color:#cbd6ff; font-size: 13px; }
    /* Matrix background */
    .matrix { position: fixed; inset:0; pointer-events:none; opacity:.18; background-image: repeating-linear-gradient(0deg, rgba(13,243,155,.15) 0 1px, transparent 1px 40px), repeating-linear-gradient(90deg, rgba(13,243,155,.1) 0 1px, transparent 1px 40px); }
    .scan { position: fixed; inset:0; pointer-events:none; background: linear-gradient(180deg, transparent, rgba(13,243,155,.05), transparent); animation: scan 5s linear infinite; }
    @keyframes scan { 0% { transform: translateY(-100%);} 100% { transform: translateY(100%);} }
    /* Terminal block list (adopted from owner-m2e.html Circuit Ripple) */
    .pb-wrap { flex:1; display:flex; flex-direction:column; gap:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pb-filter { display:flex; gap:8px; }
    .pb-filter input{ flex:1; background:#0b1430; color:#a8ffce; border:1px solid rgba(0,224,122,.3); border-radius:8px; padding:10px; }
    .pb-count { font-size:12px; color:#a8ffce; }
    .terminal { background:#050a18; border:1px solid rgba(0,224,122,.25); border-radius:10px; padding:10px; max-height:260px; overflow:auto; }
    .terminal ul { list-style:none; margin:0; padding:0; }
    .terminal li { position:relative; overflow:hidden; padding:8px 6px; border-bottom:1px dashed rgba(0,224,122,.15); display:flex; gap:8px; align-items:center; cursor:pointer; transition:background .2s ease,color .2s ease; }
    .terminal li:last-child{ border-bottom:none; }
    .caret { color:#00e07a; }
    .item { flex:1; }
    .sel { color:#00e07a; }
    .terminal li.selected{ background:#0a1a2c; color:#eafff6; box-shadow: inset 0 0 0 1px rgba(0,224,122,.25); }
    .terminal li.just::after{ content:""; position:absolute; left:12px; top:50%; width:6px; height:6px; border-radius:999px; background:#0df39b; box-shadow:0 0 0 0 rgba(13,243,155,.55), 0 0 16px rgba(13,243,155,.6); transform:translateY(-50%) scale(.8); animation:ripple 1500ms ease-out; opacity:.9; }
    @keyframes ripple { 0%{ transform:translateY(-50%) scale(.8); opacity:1; box-shadow:0 0 0 0 rgba(13,243,155,.45), 0 0 16px rgba(13,243,155,.6);} 80%{ box-shadow:0 0 0 16px rgba(13,243,155,0);} 100%{ transform:translateY(-50%) scale(120); opacity:0;} }
    .pb-hidden { position:absolute; width:1px; height:1px; left:-9999px; opacity:0; pointer-events:none; }
    .pulse { animation:pulse .45s ease; }
    @keyframes pulse { 0%{ transform:scale(1);} 50%{ transform:scale(1.06);} 100%{ transform:scale(1);} }
  </style>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="matrix"></div><div class="scan"></div>
  <header>
    <h1>Terminal Takedown - オーナー準備</h1>
  </header>
  <main>
    <div class="card">
      <div class="row">
        <label>Room ID</label>
        <input id="roomId" type="text" placeholder="例: r1" value="r1" />
        <button id="btnConnect">Connect</button>
      </div>
      <div class="row">
        <label>User Name</label>
        <input id="userName" type="text" placeholder="例: Owner" required aria-required="true" />
      </div>
      <div class="row">
        <label>Difficulty</label>
        <select id="difficulty">
          <option>Starter</option>
          <option>Basic</option>
          <option>Premium</option>
          <option>Pro</option>
        </select>
        <button id="btnRandom" class="secondary">Random 5</button>
      </div>
      <div class="row">
        <label>Problems</label>
        <div class="pb-wrap">
          <div class="pb-filter">
            <input id="pbFilter" type="text" placeholder="> filter problems" />
            <div class="pb-count">Selected: <b id="pbCnt">0</b>/5</div>
          </div>
          <div class="terminal"><ul id="pbList"></ul></div>
          <select id="problemsSelect" multiple size="7" class="pb-hidden"></select>
        </div>
      </div>
      <div id="status" class="status">未接続</div>
    </div>
  </main>
  <script>
    window.LOBBY_ROLE = 'owner';
  </script>
  <script src="./lobby.js"></script>
  <script>
    ((()=>{
      const $=id=>document.getElementById(id); const MAX=5; let sel, list, cnt, lastIdx=null; let animateOnce=[];
      function read(){ return Array.from(sel.options).map((o,i)=>({v:o.value, s:o.selected, i})); }
      function indexOf(v){ return Array.from(sel.options).findIndex(x=>x.value===v); }
      function render(){ const term = ($('pbFilter')?.value||'').trim().toLowerCase(); list.innerHTML=''; const items=read().filter(x=>x.v.toLowerCase().includes(term));
        for(const it of items){ const li=document.createElement('li'); li.dataset.v=it.v; li.className = it.s ? 'selected' : '';
          if(it.s && animateOnce.includes(it.v)){
            li.classList.add('just');
            setTimeout(()=>{ li.classList.remove('just'); }, 1600);
            animateOnce = animateOnce.filter(v=>v!==it.v);
          }
          li.innerHTML=`<span class="caret">$</span><span class="item" data-label="${it.v}">${it.v}</span><span class="sel">${it.s?'[x]':'[ ]'}</span>`; list.appendChild(li);
        }
        cnt.textContent=sel.selectedOptions.length;
      }
      function flash(){ const c=$('pbCnt'); if(!c) return; const box=c.parentElement; box.classList.add('pulse'); setTimeout(()=>box.classList.remove('pulse'),420); }
      function setSelectedByIndex(i,on){ const o=sel.options[i]; if(!o) return false; if(on && !o.selected){ if(sel.selectedOptions.length>=MAX) return false; o.selected=true; return true; } if(!on && o.selected){ o.selected=false; return true; } return true; }
      function toggleSingle(v){ const i=indexOf(v); if(i<0) return; const o=sel.options[i]; if(o.selected){ o.selected=false; }
        else { if(sel.selectedOptions.length>=MAX){ flash(); return; } o.selected=true; animateOnce.push(o.value); }
        lastIdx=i; render(); }
      function toggleRange(v, shiftKey){ const to=indexOf(v); if(to<0){ return; } if(!shiftKey || lastIdx==null){ toggleSingle(v); return; }
        const start=Math.min(lastIdx,to), end=Math.max(lastIdx,to); const willSelect = !sel.options[to].selected;
        if(willSelect){ for(let i=start;i<=end;i++){ if(sel.selectedOptions.length>=MAX){ flash(); break; } const was=sel.options[i].selected; setSelectedByIndex(i,true); if(!was && sel.options[i].selected){ animateOnce.push(sel.options[i].value); } } }
        else { for(let i=start;i<=end;i++){ setSelectedByIndex(i,false); } }
        lastIdx=to; render(); }
      function bind(){ sel=$('problemsSelect'); list=$('pbList'); cnt=$('pbCnt');
        new MutationObserver(()=>setTimeout(()=>{ lastIdx=null; render(); },0)).observe(sel,{childList:true});
        $('difficulty')?.addEventListener('change',()=>setTimeout(()=>{ lastIdx=null; render(); },0));
        $('btnRandom')?.addEventListener('click',()=>setTimeout(()=>{ lastIdx=null; render(); },0));
        $('pbFilter')?.addEventListener('input',render);
        list.addEventListener('click',e=>{ const li=e.target.closest('li[data-v]'); if(!li) return; toggleRange(li.dataset.v, e.shiftKey); });
        render(); }
      window.addEventListener('DOMContentLoaded',()=>setTimeout(bind,0));
    })());
  </script>
  <script src="./audio.js"></script>
</body>
</html>
